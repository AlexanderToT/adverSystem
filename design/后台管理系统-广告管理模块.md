# 蓝鲸时代后台管理系统 - 广告管理模块

## 1. 模块概述

广告管理模块是系统的核心业务模块之一，负责广告活动的创建、配置、投放、监控和分析。它使得运营团队能够高效地管理广告素材、设置广告参数、追踪广告效果，并根据数据进行优化。

**主要功能**:
-   广告列表管理：展示所有广告活动，支持搜索、筛选、排序。
-   广告创建与编辑：允许用户创建新的广告活动或修改现有广告活动，包括广告名称、所属应用、广告类型、目标受众、预算、投放时间等。
-   广告素材管理：上传和管理广告创意素材（图片、视频、Banner）。
-   投放参数配置：设置广告的展示方式（弹窗、横幅、Banner）、目标链接、是否展示、归属国家等。
-   数据统计与分析：展示广告的曝光量、点击量、点击率、转化量等关键指标，提供数据报表。
-   操作：编辑、删除、批量展示、批量隐藏广告。

## 2. 前端设计 (React + shadcn UI + Redux Toolkit)

### 2.1 页面结构

-   **`AdvertisementListPage.tsx`**: 展示广告列表，包含搜索、筛选、创建广告按钮、批量操作等。
-   **`AdvertisementFormPage.tsx`** (或 `AdvertisementFormDialog.tsx`): 用于创建或编辑广告，分步骤或在一个表单中收集广告信息。
    -   **步骤1: 选择广告类型** (弹窗-图片, 弹窗-视频, 横幅, Banner)。根据选择动态调整后续表单。
    -   **步骤2: 填写基本信息**：广告名称、所属应用等。
    -   **步骤3: 配置素材与链接**:
        -   **弹窗 (图片/视频)**:
            -   提供上传图片/视频的组件，上传的素材信息将以JSON格式存储在广告表中的`material_config`字段
            -   图片弹窗: 必填 `target_url`。
            -   视频弹窗: `target_url` 可选。
        -   **横幅/Banner (多图)**:
            -   提供动态列表功能，允许用户"添加图片项"。
            -   每个图片项包含："上传图片"功能和该图片对应的 `target_url` 输入框。
            -   上传的多个图片及其对应URL会组织成JSON数组，存储在广告表的`display_config`字段中。
    -   **步骤4: 投放设置**：目标链接（对于弹窗类型）、是否展示、归属国家、点击量统计配置。
    -   （高级设置：如预算、排期、频次控制等，根据图片细化）
-   **`AdvertisementDetailsPage.tsx`**: 展示单个广告的详细信息和其效果数据。

### 2.2 主要组件 (shadcn UI)

-   **`AdsTable.tsx`**: 使用 `Table` 展示广告列表，包含操作（编辑、删除、查看详情、切换展示状态）。
-   **`AdForm.tsx`**: 复杂表单，使用 `Input`, `Select`, `Textarea`, `DatePicker`, `FileUpload` (自定义或集成库), `Switch` 等组件。
-   **`MaterialUploader.tsx`**: 广告素材上传组件，直接将文件上传到R2，并返回URL和其他元数据，以JSON格式存储。
-   **`StatsChart.tsx`**: 使用图表库（如 Recharts, Chart.js）展示广告效果数据。
-   **`FilterBar.tsx`**: 用于广告列表的筛选（如下拉选择国家、应用、广告类型等）。
-   **`MultipleImageUploader.tsx`**: 新增组件，用于横幅/Banner广告上传管理多个图片，每个图片对应一个URL。

### 2.3 状态管理 (Redux Toolkit)

-   **`advertisementSlice.ts`**:
    -   `advertisements`: 广告活动列表。
    -   `currentAdvertisement`: 当前查看或编辑的广告详情。
    -   `status`: API请求状态。
    -   `error`: 错误信息。
    -   **Thunks**:
        -   `fetchAdvertisements(params)`
        -   `fetchAdvertisementById(adId)`
        -   `createAdvertisement(adData)` // 包含素材上传和广告数据创建
        -   `updateAdvertisement(adId, adData)`
        -   `deleteAdvertisement(adId)`
        -   `uploadMaterial(fileData)` // 上传素材并返回URL和元数据
        -   `fetchAdvertisementStats(adId, dateRange)`
        -   `batchUpdateAdsStatus(adIds, show)`

### 2.4 路由 (React Router 6)

```typescript
// src/App.tsx or routes configuration
<Routes>
  <Route path="/admin/advertisements" element={<AuthGuard><AdvertisementListPage /></AuthGuard>} />
  <Route path="/admin/advertisements/new" element={<AuthGuard><AdvertisementFormPage /></AuthGuard>} />
  <Route path="/admin/advertisements/:id/edit" element={<AuthGuard><AdvertisementFormPage /></AuthGuard>} />
  <Route path="/admin/advertisements/:id" element={<AuthGuard><AdvertisementDetailsPage /></AuthGuard>} />
  {/* <Route path="/admin/creatives" element={<AuthGuard><AdCreativeLibraryPage /></AuthGuard>} /> */}
</Routes>
```

### 2.5 API 服务 (`src/services/advertisementApi.ts` - Axios)

```typescript
import axiosInstance from './axiosConfig';

export const getAdvertisements = (params) => axiosInstance.get('/advertisements', { params });
export const getAdvertisementById = (id) => axiosInstance.get(`/advertisements/${id}`);
export const createAdvertisement = (adData) => axiosInstance.post('/advertisements', adData);
export const updateAdvertisement = (id, adData) => axiosInstance.put(`/advertisements/${id}`, adData);
export const deleteAdvertisement = (id) => axiosInstance.delete(`/advertisements/${id}`);

export const uploadMaterial = (formData) => axiosInstance.post('/materials/upload', formData, { headers: { 'Content-Type': 'multipart/form-data' } });

export const getAdvertisementStats = (id, params) => axiosInstance.get(`/advertisements/${id}/stats`, { params });
export const batchUpdateAdsStatus = (data) => axiosInstance.post('/advertisements/batch-status', data);
```

## 3. 后端设计 (Hono.js + Cloudflare Workers)

### 3.1 目录结构 (Conceptual)

```
src/
├── advertisements/           # 广告管理模块
│   ├── ad.routes.ts          # 广告、素材上传、统计相关路由
│   ├── ad.controller.ts      # 请求处理
│   ├── ad.service.ts         # 核心业务逻辑
│   ├── ad.validation.ts      # 输入验证 (Zod)
│   ├── advertisement.model.ts # 广告 Drizzle schema
│   └── adStat.model.ts       # 广告统计 Drizzle schema
├── middleware/
│   └── auth.middleware.ts
└── index.ts
```

### 3.2 主要逻辑

-   **广告管理 CRUD**:
    -   创建/更新广告时，根据 `ad_type` 进行校验：
        -   **弹窗 (图片/视频)**: 前端上传素材文件到R2，获得URL等信息，这些信息作为JSON存储在广告的`material_config`字段中。
        -   **横幅/Banner (多图)**: 多个图片的URL和对应的目标链接组成数组，存储在广告的`display_config`字段中。
    -   关联应用、记录各种配置参数。
-   **素材管理**:
    -   处理文件上传 (图片、视频)，存储到R2，并将URL和元数据返回给前端，前端将这些信息作为JSON直接存储在广告表中。
    -   不需要单独的素材表来记录元数据。
-   **广告投放逻辑 (模拟)**:
    -   存储广告的投放规则，如目标国家、广告类型（弹窗、横幅）。
    -   `is_display` 字段控制广告的显隐。
-   **数据统计**:
    -   记录广告的曝光、点击等基础事件（通常由前端SDK或广告展示端配合上报，后台提供接收接口或批量导入）。
    -   聚合统计数据，生成报表。
-   **批量操作**:
    -   实现批量展示/隐藏广告的功能。

### 3.3 基础代码示例 (Conceptual)

**`src/advertisements/ad.routes.ts` (Hono.js)**
```typescript
import { Hono } from 'hono';
import {
    createAdvertisementHandler,
    getAdvertisementsHandler,
    getAdvertisementByIdHandler,
    updateAdvertisementHandler,
    deleteAdvertisementHandler,
    uploadMaterialHandler,
    getAdStatsHandler,
    batchUpdateAdsStatusHandler
} from './ad.controller';
import { protect } from '../middleware/auth.middleware'; // Assuming auth middleware

const adRouter = new Hono();
adRouter.use('*', protect); // Protect all ad routes

adRouter.post('/', createAdvertisementHandler);
adRouter.get('/', getAdvertisementsHandler);
adRouter.get('/:id', getAdvertisementByIdHandler);
adRouter.put('/:id', updateAdvertisementHandler);
adRouter.delete('/:id', deleteAdvertisementHandler);

adRouter.post('/materials/upload', uploadMaterialHandler); // 处理素材上传到R2并返回URL和元数据

adRouter.get('/:id/stats', getAdStatsHandler);
adRouter.post('/batch-status', batchUpdateAdsStatusHandler);

export default adRouter;
```

## 4. 数据库表设计 (PostgreSQL with Drizzle ORM)

根据图片信息和常规广告管理需求，设计以下核心表：

### 4.1 `advertisements` 表
存储广告活动的核心信息。

| 字段名             | 类型                        | 约束/描述                                       | 对应图片字段 |
|--------------------|-----------------------------|-------------------------------------------------|--------------|
| `id`               | `UUID`                      | 主键                                            |              |
| `name`             | `VARCHAR(255)`              | 非空, 广告名称                                  | 广告名称     |
| `ad_type`          | `VARCHAR(50)`               | 非空 (e.g., 'popup_image', 'popup_video', 'banner_multiple_image', 'strip_multiple_image') | 广告类型 (弹窗/横幅/Banner) |
| `target_url`       | `TEXT`                      | **可空**. 主要用于弹窗类型广告的单一跳转链接.   | 目标地址     |
| `material_config`  | `JSONB`                     | 存储素材信息，包含URL、类型、尺寸等。<br> - 弹窗: 单个素材对象。<br> - 横幅/Banner: 通常为NULL（素材信息在`display_config`）。 | 缩略图/图片/视频 |
| `display_config`   | `JSONB`                     | **可空**. <br> - 横幅/Banner: 存储 `[{material_url: TEXT, target_url: TEXT, ...其他元数据}, ...]` 结构. <br> - 弹窗: 通常为NULL. |              |
| `country_codes`    | `VARCHAR(10)[]`             | 目标国家代码列表 (e.g., ['US', 'CN'])           | 归属国家     |
| `is_displayed`     | `BOOLEAN`                   | `DEFAULT TRUE`, 是否展示                        | 是否展示     |
| `total_clicks`     | `BIGINT`                    | `DEFAULT 0`, 此广告在所有应用中的总点击量 (通过统计系统更新) |              |
| `created_at`       | `TIMESTAMP WITH TIME ZONE`  | `DEFAULT CURRENT_TIMESTAMP`                     |              |
| `updated_at`       | `TIMESTAMP WITH TIME ZONE`  | `DEFAULT CURRENT_TIMESTAMP`                     |              |

**Drizzle Schema (`src/advertisements/advertisement.model.ts`)**:
```typescript
import { pgTable, uuid, varchar, boolean, timestamp, text, jsonb, specificType, bigint } from 'drizzle-orm/pg-core';
import { relations } from 'drizzle-orm';
// import { applications } from '../applications/application.model'; // Application model from its module

export const advertisements = pgTable('advertisements', {
  id: uuid('id').defaultRandom().primaryKey(),
  name: varchar('name', { length: 255 }).notNull(),
  adType: varchar('ad_type', { length: 50 }).notNull(),
  targetUrl: text('target_url'),
  materialConfig: jsonb('material_config'), // 存储素材信息JSON
  displayConfig: jsonb('display_config'), // 用于多图广告的配置
  countryCodes: specificType('country_codes', 'varchar(10)[]'),
  isDisplayed: boolean('is_displayed').default(true).notNull(),
  totalClicks: bigint('total_clicks', { mode: 'number' }).default(0),
  createdAt: timestamp('created_at', { withTimezone: true }).defaultNow().notNull(),
  updatedAt: timestamp('updated_at', { withTimezone: true }).defaultNow().notNull(),
});

export const advertisementsRelations = relations(advertisements, ({ many }) => ({
  // 可能的应用关联
}));
```

### 4.2 `ad_statistics` 表 与 统计方案
广告点击和曝光等原始事件的统计将依赖于 PostgreSQL 数据库。

-   **`ad_statistics` 表**: 此表用于记录原始的广告事件，如点击和曝光。
    | 字段名         | 类型                        | 约束/描述                                     |
    |----------------|-----------------------------|-----------------------------------------------|
    | `id`           | `BIGSERIAL` or `UUID`       | 主键                                          |
    | `advertisement_id`| `UUID`                   | 外键, 关联 `advertisements.id`. **广告被点击/曝光时必须记录.** |
    | `application_id` | `UUID`                   | 外键, 关联 `applications.id`. **广告在哪个应用内被点击/曝光时必须记录.** |
    | `event_type`   | `VARCHAR(50)`               | 非空 (e.g., 'click', 'impression')            |
    | `event_time`   | `TIMESTAMP WITH TIME ZONE`  | `DEFAULT CURRENT_TIMESTAMP`, 事件发生时间     |
    | `country_code` | `VARCHAR(10)`               | 可选, 事件发生地国家                          |
    *Drizzle schema (`src/advertisements/adStat.model.ts`) 会相应定义此表。*

-   **数据写入**: 当广告被点击或曝光时，前端SDK或后端逻辑应将包含 `advertisement_id` 和 `application_id` 的事件数据写入 `ad_statistics` 表。

-   **数据查询与聚合**:
    -   **广告总点击量 (更新 `advertisements.total_clicks`)**: 
        -   **选项1 (实时/近实时更新)**: 每次向 `ad_statistics` 写入一条点击记录时，同时在同一事务中执行 `UPDATE advertisements SET total_clicks = total_clicks + 1 WHERE id = <clicked_ad_id>;`。这保证了数据的一致性，但可能在高并发写入时影响性能。
        -   **选项2 (定期聚合)**: 设置一个后台定时任务，定期从 `ad_statistics` 表中按 `advertisement_id` 聚合点击总数，然后批量更新到 `advertisements.total_clicks` 字段。此方法对主业务性能影响较小，但数据有一定延迟。
    -   **应用相关的广告点击量 (用于应用详情)**: 后端在处理应用详情请求时，通过SQL查询 `ad_statistics` 表，例如: `SELECT advertisement_id, COUNT(*) as clicks FROM ad_statistics WHERE application_id = <app_id> AND event_type = 'click' GROUP BY advertisement_id;`。如果需要点击率，还需查询曝光量并计算。

-   **性能考虑**: 
    -   对于 `ad_statistics` 表，应在 `advertisement_id`, `application_id`, `event_type`, 和 `event_time` 上建立合适的索引以优化查询性能。
    -   如果数据量巨大，可以考虑对 `ad_statistics` 表按 `event_time` 进行分区。

## 5. API 接口设计 (RESTful)

所有接口均以 `/api/advertisements` 或 `/api/materials` 为前缀。

### 5.1 广告管理接口 (`/api/advertisements`)

-   **`GET /`**
    -   描述: 获取广告列表 (支持分页、搜索、筛选)。
    -   查询参数: `?page=1&limit=10&search=keyword&applicationId=uuid&adType=banner&country=US`
    -   成功响应 (200): `{ "data": [ad_objects], "pagination": { ... } }`
-   **`POST /`**
    -   描述: 创建新广告。
    -   请求体:
        -   通用字段: `name`, `ad_type`, `country_codes`, `is_displayed`。
        -   **IF `ad_type` IS 'popup_image' or 'popup_video'**: `material_config` (JSON对象，包含URL、类型等), `target_url` (对于图片是必填，对于视频是可选)。
        -   **IF `ad_type` IS 'banner_multiple_image' OR 'strip_multiple_image'**: `display_config` (JSON数组，每项包含 `material_url`, `target_url` 等)。
    -   成功响应 (201_CREATED): `{ ...created_ad_object }`
-   **`GET /:id`**
    -   描述: 获取指定广告详情。
    -   成功响应 (200): `{ ...ad_object_with_material_details }`
-   **`PUT /:id`**
    -   描述: 更新指定广告。
    -   请求体: (同POST, 但所有字段可选，根据 `ad_type` 校验对应字段).
    -   成功响应 (200_OK): `{ ...updated_ad_object }`
-   **`DELETE /:id`**
    -   描述: 删除指定广告。
    -   成功响应 (204): No Content
-   **`POST /batch-status`**
    -   描述: 批量更新广告的展示状态。
    -   请求体: `{ "adIds": ["uuid1", "uuid2"], "isDisplayed": boolean }`
    -   成功响应 (200): `{ "message": "Status updated for X ads" }`
-   **`GET /:id/stats`**
    -   描述: 获取指定广告的统计数据。
    -   查询参数: `?startDate=YYYY-MM-DD&endDate=YYYY-MM-DD&groupBy=day`
    -   成功响应 (200): `{ "data": [daily_stats_objects] }`

### 5.2 素材上传接口 (`/api/materials`)

-   **`POST /upload`**
    -   描述: 上传广告素材到R2存储。
    -   请求体: `multipart/form-data` 包含文件。
    -   成功响应 (201): `{ "url": "https://r2.example.com/path/to/file", "fileType": "image/jpeg", "dimensions": "800x600", ... }` (返回素材URL和元数据，前端会将这些数据作为JSON存储到广告表)

---
此文档为广告管理模块提供了一个全面的设计框架。实际开发中，需要根据业务细节、具体的用户故事和性能要求进行调整和细化。 