# 蓝鲸时代后台管理系统 - 代码开发计划

## 概览
本文档旨在规划和跟踪"蓝鲸时代后台管理系统"的详细代码开发任务。项目技术栈主要包括：
- **前端**: React 18, shadcn/ui (violet), SCSS, Redux Toolkit, React Router 6, Axios, Vite。
- **后端**: Hono.js (Cloudflare Workers), PostgreSQL, Drizzle-kit, Redis, JWT。
- **文件存储**: Cloudflare R2。

## 图例
- `☐` 未完成
- `✅` 已完成
- `⏳` 进行中

---

## 一、 项目初始化与通用设置
- `☐` **后端：Hono.js 项目搭建**
    - `☐` 基于 Cloudflare Workers 模板创建 Hono.js 项目
    - `☐` 配置 TypeScript
    - `☐` 引入基础依赖 (e.g., Zod, Drizzle ORM, Redis client)
- `☐` **前端：React + Vite 项目搭建**
    - `☐` 使用 Vite 创建 React + TypeScript 项目
    - `☐` 配置 SCSS
    - `☐` 安装核心依赖 (Redux Toolkit, React Router, Axios, shadcn/ui)
- `☐` **代码规范配置**
    - `☐` 前后端 ESLint 配置
    - `☐` 前后端 Prettier 配置
- `☐` **API 文档工具**
    - `☐` 后端集成 OpenAPI/Swagger (e.g., using `hono/swagger-ui`)

---

## 二、 数据库层 (PostgreSQL + Drizzle ORM)
- `☐` **Drizzle ORM 初始化**
    - `☐` 安装 `drizzle-orm` 和 `drizzle-kit`
    - `☐` 创建 `drizzle.config.ts` 配置文件
- `☐` **数据库 Schema 定义 (位于各模块的 `.model.ts` 或统一的 `db/schema.ts`)**
    - `☐` `users` 表 Schema (`src/accounts/user.model.ts`)
    - `☐` `roles` 表 Schema (`src/accounts/role.model.ts`)
    - `☐` `user_roles` (连接表) Schema (`src/accounts/userRoles.model.ts` or within user/role model)
    - `☐` `applications` 表 Schema (`src/applications/application.model.ts`)
    - `☐` `app_ad_placements` 表 Schema (`src/applications/application.model.ts` or separate)
    - `☐` `advertisements` 表 Schema (`src/advertisements/advertisement.model.ts`)
    - `☐` `ad_statistics` 表 Schema (`src/advertisements/adStat.model.ts`)
- `☐` **数据库迁移**
    - `☐` 生成初始迁移脚本 (`drizzle-kit generate:pg`)
    - `☐` 建立数据库迁移和应用机制 (`drizzle-kit push:pg` 或自定义脚本)

---

## 三、 后端开发 (Hono.js on Cloudflare Workers)

### 1. 核心中间件与服务 (`src/middleware/`, `src/services/`)
- `☐` **JWT 认证与授权中间件** (`src/middleware/auth.middleware.ts`)
    - `☐` Token 生成与校验逻辑
    - `☐` 角色权限检查
- `☐` **Redis 服务**
    - `☐` Redis 客户端初始化与连接 (Cloudflare Workers KV or external Redis)
    - `☐` JWT 黑名单管理服务
- `☐` **统一错误处理中间件**
- `☐` **Cloudflare R2 服务**
    - `☐` 生成预签名 URL (presigned URL) 的服务

### 2. 账号管理模块 (`src/accounts/`)
- `☐` **输入验证** (`account.validation.ts` using Zod)
    - `☐` 登录、注册、用户创建/更新等DTO验证
- `☐` **业务逻辑服务** (`account.service.ts`)
    - `☐` 用户 CRUD (密码哈希处理)
    - `☐` 角色 CRUD
    - `☐` 用户分配角色
    - `☐` 登录逻辑 (生成 JWT)
    - `☐` 登出逻辑 (JWT 加入 Redis 黑名单)
- `☐` **控制器** (`account.controller.ts`)
    - `☐` 处理 HTTP 请求，调用 Service
- `☐` **路由定义** (`account.routes.ts`)
    - `☐` 定义 `/auth/login`, `/auth/logout`, `/users`, `/roles` 等端点

### 3. 应用管理模块 (`src/applications/`)
- `☐` **输入验证** (`application.validation.ts` using Zod)
    - `☐` 应用创建/更新 DTO 验证
    - `☐` 广告位配置 DTO 验证
- `☐` **业务逻辑服务** (`application.service.ts`)
    - `☐` 应用 CRUD (自动生成 `app_key`)
    - `☐` 应用 Logo URL 管理 (配合 R2 预签名 URL)
    - `☐` `app_ad_placements` 管理 (增删改查应用的广告位及绑定的广告)
- `☐` **控制器** (`application.controller.ts`)
- `☐` **路由定义** (`application.routes.ts`)
    - `☐` 定义 `/applications`, `/applications/:id/ad-placements` 等端点

### 4. 广告管理模块 (`src/advertisements/`)
- `☐` **输入验证** (`ad.validation.ts` using Zod)
    - `☐` 广告创建/更新 DTO 验证 (包括 `material_config`, `display_config` JSON 结构)
- `☐` **业务逻辑服务** (`ad.service.ts`)
    - `☐` 广告 CRUD
    - `☐` `material_config` 和 `display_config` 的处理与存储
    - `☐` 广告素材 URL 管理 (配合 R2 预签名 URL)
    - `☐` `ad_statistics` 原始数据记录接口
    - `☐` `advertisements.total_clicks` 聚合更新逻辑 (可能通过定时任务或触发器，或在相关操作后)
- `☐` **控制器** (`ad.controller.ts`)
- `☐` **路由定义** (`ad.routes.ts`)
    - `☐` 定义 `/advertisements`, `/advertisements/:id/stats` 等端点

---

## 四、 前端开发 (React + Vite)

### 1. 核心架构与配置
- `☐` **项目结构** (`src/` 目录 согласно `project-structure.mdc`)
- `☐` **Redux Toolkit Store** (`src/store/index.ts` or `src/store/store.ts`)
    - `☐` `configureStore`
    - `☐` Root Reducer 和 State 定义
- `☐` **React Router 6 配置** (`src/App.tsx` or `src/Router.tsx`)
    - `☐` Public 和 Private 路由
    - `☐` 路由懒加载 (`React.lazy`, `Suspense`)
- `☐` **Axios 实例与 API 服务封装** (`src/services/api.ts`)
    - `☐` Base URL, interceptors (请求头携带 JWT, 统一错误处理)
    - `☐` 各模块的 API 服务函数 (e.g., `authApi.ts`, `applicationApi.ts`)
- `☐` **全局样式与 SCSS** (`src/styles/`)
    - `☐` `main.scss` (全局样式, 变量, mixins)
    - `☐` shadcn/ui 主题 (violet) 配置与全局 CSS 变量
- `☐` **TypeScript 类型定义** (`src/types/`)
    - `☐` API 响应类型
    - `☐` 实体模型类型

### 2. 布局与通用组件
- `☐` **认证布局** (`src/layouts/AuthLayout.tsx`)
- `☐` **管理后台主布局** (`src/layouts/AdminLayout.tsx`)
    - `☐` 侧边导航栏
    - `☐` 顶部面包屑/用户信息
    - `☐` 内容区域
- `☐` **通用 UI 组件** (`src/components/ui/` - 扩展或自定义 shadcn 组件)
    - `☐` 例如：`DataTable`, `ConfirmationDialog`, `FileUpload` 等
- `☐` **表单组件封装** (`src/components/forms/`)
    - `☐` 基于 `react-hook-form` 和 `shadcn/ui` 的表单控件

### 3. 账号管理模块 (前端)
- `☐` **Redux Slice (Auth & Users)** (`src/store/slices/authSlice.ts`, `src/store/slices/userSlice.ts`)
    - `☐` State, Reducers, Async Thunks (login, logout, fetchUser, CRUD users)
- `☐` **登录页面** (`src/pages/account/LoginPage.tsx`)
    - `☐` 表单与提交逻辑
- `☐` **用户列表页面** (`src/pages/account/UserListPage.tsx`)
    - `☐` 用户数据显示、分页、搜索
    - `☐` 用户创建/编辑/删除操作触发
- `☐` **用户表单/模态框** (组件)
- `☐` **角色管理界面** (若有，或集成在用户管理中)

### 4. 应用管理模块 (前端)
- `☐` **Redux Slice (Applications)** (`src/store/slices/applicationSlice.ts`)
    - `☐` State, Reducers, Async Thunks (CRUD applications, manage ad placements)
- `☐` **应用列表页面** (`src/pages/application/ApplicationListPage.tsx`)
    - `☐` 应用数据显示、分页、搜索
- `☐` **应用创建/编辑表单页面** (`src/pages/application/ApplicationFormPage.tsx`)
    - `☐` 应用信息表单
    - `☐` Logo 上传组件 (使用 R2 预签名 URL)
    - `☐` 广告位配置界面 (动态增删、指派广告)

### 5. 广告管理模块 (前端)
- `☐` **Redux Slice (Advertisements)** (`src/store/slices/advertisementSlice.ts`)
    - `☐` State, Reducers, Async Thunks (CRUD advertisements)
- `☐` **广告列表页面** (`src/pages/advertisement/AdvertisementListPage.tsx`)
    - `☐` 广告数据显示、筛选、分页
- `☐` **广告创建/编辑表单页面** (`src/pages/advertisement/AdvertisementFormPage.tsx`)
    - `☐` 广告信息表单
    - `☐` 素材配置组件 (`material_config` 和 `display_config` JSON 的友好编辑界面)
    - `☐` 广告素材上传 (若适用，使用 R2 预签名 URL)
- `☐` **广告统计展示** (组件或页面部分)
    - `☐` 展示 `total_clicks`
    - `☐` 按应用展示广告点击数据 (调用聚合查询接口)

---

## 五、 测试与部署

### 1. 测试
- `☐` **后端测试**
    - `☐` 单元测试 (Services, Utils)
    - `☐` 集成测试 (API Endpoints)
- `☐` **前端测试**
    - `☐` 组件测试 (React Testing Library)
    - `☐` 端到端测试 (e.g., Playwright or Cypress) - *可选*

### 2. 部署
- `☐` **后端部署**
    - `☐` Cloudflare Workers `wrangler.toml` 配置
    - `☐` 环境变量配置 (Secrets) for DB, Redis, R2 credentials
    - `☐` 部署脚本/CI/CD
- `☐` **前端部署**
    - `☐` Vite 打包优化配置
    - `☐` 部署到 Cloudflare Pages 或其他静态托管平台
    - `☐` CI/CD

---
这份文档会创建在 `design/蓝鲸时代后台管理系统-开发任务清单.md`。请检查内容是否符合您的期望。后续您可以根据实际进度更新每个任务的状态。 