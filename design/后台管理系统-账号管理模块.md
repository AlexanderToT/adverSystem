# 蓝鲸时代后台管理系统 - 账号管理模块

## 1. 模块概述

账号管理模块是系统的核心组成部分，负责管理所有系统用户的账户信息、角色分配以及权限控制。它确保系统的安全性，使得不同角色的用户能够在其权限范围内操作系统功能。

**主要功能**:
-   用户信息的增、删、改、查 (CRUD)。
-   用户登录认证与会话管理 (JWT)。
-   角色管理（例如：超级管理员、普通用户）。
-   用户角色分配。
-   密码管理（创建、重置）。

## 2. 前端设计 (React + Ant Design + Redux Toolkit)

### 2.1 页面结构

-   **`LoginPage.tsx`**: 用户登录页面。
-   **`AccountListPage.tsx`**: 展示用户列表，提供搜索、筛选、添加新用户、编辑和删除用户等功能。
-   **`AccountForm.tsx`**: (可作为页面或Modal组件) 用于创建新用户或编辑现有用户信息，包括用户名、密码（创建时）、角色分配等。
-   **`RoleManagementPage.tsx`**: (如果需要更细致的角色和权限管理) 展示角色列表，允许创建、编辑角色及其权限。

### 2.2 主要组件 (Ant Design)

-   **`UserTable.tsx`**: 使用 `Table` 组件展示用户信息，包含操作按钮。
-   **`UserFormModal.tsx`**: 使用 `Modal`, `Form`, `Input`, `Select` 等组件构建用户创建/编辑表单。
-   **`RoleSelector.tsx`**: 使用 `Select` 或 `Checkbox.Group` 组件为用户分配角色。
-   **`TablePagination`**: 使用 `Pagination` 组件实现用户列表的分页。

### 2.3 状态管理 (Redux Toolkit)

-   **`accountSlice.ts`**:
    -   `users`: 用户列表。
    -   `currentUser`: 当前登录用户信息。
    -   `roles`: 系统角色列表。
    -   `status`: (idle | loading | succeeded | failed) API请求状态。
    -   `error`: 错误信息。
    -   **Thunks**:
        -   `loginUser(credentials)`
        -   `fetchUsers()`
        -   `fetchUserById(userId)`
        -   `createUser(userData)`
        -   `updateUser(userId, userData)`
        -   `deleteUser(userId)`
        -   `fetchRoles()`
        -   `assignRoleToUser(userId, roleId)`

### 2.4 路由 (React Router 6)

```typescript
// src/App.tsx or routes configuration
<Routes>
  <Route path="/login" element={<LoginPage />} />
  <Route path="/admin/accounts" element={<AuthGuard><AccountListPage /></AuthGuard>} />
  {/* Potentially more routes for account creation/editing if not using modals */}
  <Route path="/admin/roles" element={<AuthGuard><RoleManagementPage /></AuthGuard>} /> {/* If applicable */}
</Routes>
```

### 2.5 API 服务 (`src/services/accountApi.ts` - Axios)

```typescript
// Conceptual structure
import axiosInstance from './axiosConfig';

export const login = (credentials) => axiosInstance.post('/auth/login', credentials);
export const getCurrentUser = () => axiosInstance.get('/auth/me');

export const getUsers = (params) => axiosInstance.get('/users', { params });
export const getUserById = (id) => axiosInstance.get(`/users/${id}`);
export const createUser = (userData) => axiosInstance.post('/users', userData);
export const updateUser = (id, userData) => axiosInstance.put(`/users/${id}`, userData);
export const deleteUser = (id) => axiosInstance.delete(`/users/${id}`);

export const getRoles = () => axiosInstance.get('/roles');
// Potentially more role/permission related API calls
```

## 3. 后端设计 (Hono.js + Cloudflare Workers)

### 3.1 目录结构 (Conceptual)

```
src/
├── controllers/
│   └── account.controller.ts # 请求处理
├── routes/
│   └── account.routes.ts # 相关路由
├── service/
│   └── account.service.ts # 核心业务逻辑
├── validation/ 
│   └── account.validation.ts #  输入验证 (Zod)         
├── middleware/
│   └── auth-unified.middleware.ts
└── index.ts
```

### 3.2 主要逻辑

-   **用户认证与会话管理**:
    -   接收登录请求（用户ID/登录账号, 密码）。
    -   校验用户信息，比对哈希密码。
    -   成功则生成JWT返回。
    -   用户登出时，服务端接收到的JWT将被加入黑名单（例如存储在Redis中），直到该Token的自然过期时间到达。这意味着即使Token本身未过期，一旦被列入黑名单，后续请求将视为无效。
-   **用户管理**:
    -   CRUD操作，密码使用`bcrypt`等库进行哈希存储。
    -   创建用户时，关联默认角色或指定角色。
-   **角色管理**:
    -   定义角色（如：`super_admin`, `user`）。
    -   （可选）定义权限点，并将权限点关联到角色。
-   **授权**:
    -   通过JWT解析用户身份和角色。
    -   在需要权限控制的路由或服务方法前添加授权中间件，校验用户角色是否拥有操作权限。

### 3.3 基础代码示例 (Conceptual)

**`src/accounts/account.routes.ts` (Hono.js)**
```typescript
import { Hono } from 'hono';
import { jwt } from 'hono/jwt'; // Assuming JWT middleware
import {
    loginHandler,
    registerHandler,
    getUsersHandler,
    getUserByIdHandler,
    createUserHandler,
    updateUserHandler,
    deleteUserHandler,
    getRolesHandler
} from './account.controller';
import { protect, restrictTo } from '../middleware/auth.middleware'; // Conceptual auth middleware

const accountRouter = new Hono();

// Public routes
accountRouter.post('/auth/login', loginHandler);
// accountRouter.post('/auth/register', registerHandler); // If public registration

// Protected routes (example)
accountRouter.use('/users/*', protect); // Protect all /users routes
accountRouter.use('/roles/*', protect, restrictTo(['super_admin'])); // Roles only for super_admin

accountRouter.get('/users', getUsersHandler);
accountRouter.post('/users', restrictTo(['super_admin']), createUserHandler);
accountRouter.get('/users/:id', getUserByIdHandler);
accountRouter.put('/users/:id', updateUserHandler);
accountRouter.delete('/users/:id', restrictTo(['super_admin']), deleteUserHandler);

accountRouter.get('/roles', getRolesHandler);
// More role management routes

export default accountRouter;
```

**`src/middleware/auth.middleware.ts` (Conceptual)**
```typescript
import { Context, Next } from 'hono';
import { verify } from 'hono/jwt'; // Assuming JWT verification

export async function protect(c: Context, next: Next) {
    const authHeader = c.req.header('Authorization');
    if (!authHeader || !authHeader.startsWith('Bearer ')) {
        return c.json({ message: 'Unauthorized' }, 401);
    }
    const token = authHeader.split(' ')[1];
    try {
        // Replace 'your-secret' with env variable
        const decoded = await verify(token, process.env.JWT_SECRET || 'your-secret');
        c.set('user', decoded); // Attach user payload to context
        await next();
    } catch (err) {
        return c.json({ message: 'Invalid token' }, 401);
    }
}

export function restrictTo(roles: string[]) {
    return async (c: Context, next: Next) => {
        const user = c.get('user');
        // Assuming user object has a 'roles' array or a 'role' string
        if (!user || !user.roles || !roles.some(role => user.roles.includes(role))) {
            return c.json({ message: 'Forbidden: You do not have permission to perform this action' }, 403);
        }
        await next();
    };
}
```

## 4. 数据库表设计 (PostgreSQL with Drizzle ORM)

根据系统架构图和需求，账号管理模块至少需要以下表：

### 4.1 `users` 表
存储系统用户信息。

| 字段名        | 类型                        | 约束/描述                                  | 对应图片字段 |
|---------------|-----------------------------|--------------------------------------------|--------------|
| `id`          | `UUID`                      | 主键, `DEFAULT uuid_generate_v4()`         | 用户ID       |
| `username`    | `VARCHAR(255)`              | 唯一, 非空 (用于登录)                      | 登录账号     |
| `password_hash`| `VARCHAR(255)`              | 非空 (存储哈希后的密码)                      | 登录密码     |
| `display_name`| `VARCHAR(255)`              | 可空 (用户显示名称)                          | 用户名称     |
| `email`       | `VARCHAR(255)`              | 唯一, 可空                                 |              |
| `login_type`  | `VARCHAR(50)`               | 非空, `DEFAULT 'password'` (e.g. password, oauth) | 登录账号类型 |
| `is_active`   | `BOOLEAN`                   | 非空, `DEFAULT TRUE`                       |              |
| `created_at`  | `TIMESTAMP WITH TIME ZONE`  | `DEFAULT CURRENT_TIMESTAMP`                | 创建时间     |
| `updated_at`  | `TIMESTAMP WITH TIME ZONE`  | `DEFAULT CURRENT_TIMESTAMP`                |              |

**Drizzle Schema (`src/accounts/user.model.ts`)**:
```typescript
import { pgTable, uuid, varchar, boolean, timestamp, text } from 'drizzle-orm/pg-core';
import { relations } from 'drizzle-orm';
import { userRoles } from './role.model'; // Assuming userRoles junction table

export const users = pgTable('users', {
  id: uuid('id').defaultRandom().primaryKey(),
  username: varchar('username', { length: 255 }).unique().notNull(),
  passwordHash: varchar('password_hash', { length: 255 }).notNull(),
  displayName: varchar('display_name', { length: 255 }),
  email: varchar('email', { length: 255 }).unique(),
  loginType: varchar('login_type', { length: 50 }).default('password').notNull(),
  isActive: boolean('is_active').default(true).notNull(),
  createdAt: timestamp('created_at', { withTimezone: true }).defaultNow().notNull(),
  updatedAt: timestamp('updated_at', { withTimezone: true }).defaultNow().notNull(),
});

export const usersRelations = relations(users, ({ many }) => ({
  userRoles: many(userRoles),
}));
```

### 4.2 `roles` 表
存储系统角色信息。

| 字段名        | 类型                        | 约束/描述                                  |
|---------------|-----------------------------|--------------------------------------------|
| `id`          | `UUID`                      | 主键, `DEFAULT uuid_generate_v4()`         |
| `name`        | `VARCHAR(50)`               | 唯一, 非空 (e.g., `super_admin`, `user`)   |
| `description` | `TEXT`                      | 可空                                       |
| `created_at`  | `TIMESTAMP WITH TIME ZONE`  | `DEFAULT CURRENT_TIMESTAMP`                |
| `updated_at`  | `TIMESTAMP WITH TIME ZONE`  | `DEFAULT CURRENT_TIMESTAMP`                |

**Drizzle Schema (`src/accounts/role.model.ts`)**:
```typescript
import { pgTable, uuid, varchar, text, timestamp } from 'drizzle-orm/pg-core';
import { relations } from 'drizzle-orm';
import { users } from './user.model'; // Assuming users table schema

export const roles = pgTable('roles', {
  id: uuid('id').defaultRandom().primaryKey(),
  name: varchar('name', { length: 50 }).unique().notNull(),
  description: text('description'),
  createdAt: timestamp('created_at', { withTimezone: true }).defaultNow().notNull(),
  updatedAt: timestamp('updated_at', { withTimezone: true }).defaultNow().notNull(),
});

// Junction table for many-to-many relationship between users and roles
export const userRoles = pgTable('user_roles', {
  userId: uuid('user_id').notNull().references(() => users.id, { onDelete: 'cascade' }),
  roleId: uuid('role_id').notNull().references(() => roles.id, { onDelete: 'cascade' }),
  // If you need a primary key on the junction table:
  // primaryKey: primaryKey(userRoles.userId, userRoles.roleId),
});

export const rolesRelations = relations(roles, ({ many }) => ({
  userRoles: many(userRoles),
}));

export const userRolesRelations = relations(userRoles, ({ one }) => ({
  user: one(users, {
    fields: [userRoles.userId],
    references: [users.id],
  }),
  role: one(roles, {
    fields: [userRoles.roleId],
    references: [roles.id],
  }),
}));
```
*(Note: Permissions table (`permissions`) and `role_permissions` junction table can be added if a more granular permission system is required beyond predefined roles.)*

## 5. API 接口设计 (RESTful)

所有接口均以 `/api` 为前缀。

### 5.1 认证接口 (`/api/auth`)

-   **`POST /login`**
    -   描述: 用户登录。
    -   请求体: `{ "username": "string", "password": "string" }`
    -   成功响应 (200): `{ "token": "jwt_token", "user": { ...user_details } }`
    -   失败响应 (400, 401): `{ "message": "error_message" }`
-   **`GET /me`** (需要认证)
    -   描述: 获取当前登录用户信息。
    -   成功响应 (200): `{ ...user_details_with_roles }`
    -   失败响应 (401): `{ "message": "Unauthorized" }`
-   **`POST /logout`** (需要认证)
    -   描述: 用户登出。服务端会将当前会话的JWT加入黑名单 (如Redis)，使其立即失效，直到自然过期。
    -   成功响应 (200): `{ "message": "Logged out successfully" }`

### 5.2 用户管理接口 (`/api/users`) (多数需要`super_admin`权限)

-   **`GET /`**
    -   描述: 获取用户列表 (支持分页、搜索、筛选)。
    -   查询参数: `?page=1&limit=10&search=keyword&role=user`
    -   成功响应 (200): `{ "data": [user_objects], "pagination": { ... } }`
-   **`POST /`**
    -   描述: 创建新用户。
    -   请求体: `{ "username": "string", "password": "string", "displayName": "string", "email": "string", "roles": ["role_id_1"] }`
    -   成功响应 (201): `{ ...created_user_object }`
-   **`GET /:id`**
    -   描述: 获取指定用户信息。
    -   成功响应 (200): `{ ...user_object_with_roles }`
-   **`PUT /:id`**
    -   描述: 更新指定用户信息。
    -   请求体: `{ "displayName": "string", "email": "string", "isActive": boolean, "roles": ["role_id_1"] }`
    -   成功响应 (200): `{ ...updated_user_object }`
-   **`DELETE /:id`**
    -   描述: 删除指定用户。
    -   成功响应 (204): No Content
-   **`PUT /:id/change-password`**
    -   描述: 修改指定用户的密码 (通常由管理员操作)。
    -   请求体: `{ "newPassword": "string" }`
    -   成功响应 (200): `{ "message": "Password updated successfully" }`

### 5.3 角色管理接口 (`/api/roles`) (需要`super_admin`权限)

-   **`GET /`**
    -   描述: 获取所有角色列表。
    -   成功响应 (200): `[ { "id": "uuid", "name": "string", "description": "string" }, ... ]`
-   **`POST /`**
    -   描述: 创建新角色。
    -   请求体: `{ "name": "string", "description": "string" }`
    -   成功响应 (201): `{ ...created_role_object }`
-   **`GET /:id`**
    -   描述: 获取指定角色信息。
    -   成功响应 (200): `{ ...role_object }`
-   **`PUT /:id`**
    -   描述: 更新指定角色信息。
    -   请求体: `{ "name": "string", "description": "string" }`
    -   成功响应 (200): `{ ...updated_role_object }`
-   **`DELETE /:id`**
    -   描述: 删除指定角色 (需注意处理已关联此角色的用户)。
    -   成功响应 (204): No Content

---

此文档提供了账号管理模块的详细设计框架。在实际开发过程中，可以根据具体需求进一步细化和调整。
