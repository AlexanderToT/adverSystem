# 蓝鲸时代后台管理系统 - 应用管理模块

## 1. 模块概述

应用管理模块是连接广告主或开发者应用与本广告投放系统的桥梁。它负责应用的接入、配置、审核（如果需要）以及与广告活动关联。一个应用可以理解为一个App、网站或其他数字媒体，它们将通过本系统来展示广告。

**主要功能**:
-   应用列表管理：展示所有接入的应用，支持搜索、筛选、排序。
-   应用创建与编辑：允许用户（通常是管理员或具有权限的广告主代表）添加新应用或修改现有应用信息。
    -   基本信息：应用名称、应用Logo、应用终端 (Android/iOS)、官网地址。
    -   配置信息：应用唯一识别码 (App Key/应用码，由系统生成或用户提供用于SDK集成)、平台特定配置（如iOS的Bundle ID，Android的Package Name）。
-   应用状态管理：例如，待审核、已上线、已下线、已禁用等状态。
-   广告关联：在应用编辑时，可以为应用指定的三个广告位（弹窗、横幅、Banner）分别关联一个广告活动。每个广告位只能关联一个广告，更改关联会替换掉原有的。
-   （可选）应用审核流程。
-   （可选）应用相关的统计数据概览（例如，通过此应用展示的广告总曝光/点击）。

## 2. 前端设计 (React + shadcn UI + Redux Toolkit)

### 2.1 页面结构

-   **`ApplicationListPage.tsx`**: 展示应用列表，提供搜索、筛选、添加新应用按钮。
-   **`ApplicationFormPage.tsx`** (或 `ApplicationFormDialog.tsx`): 用于创建或编辑应用。
    -   表单项：应用名称、应用Logo上传、应用终端选择 (Android/iOS)、官网地址。
    -   显示系统生成的应用码 (App Key)。
    -   **广告关联区域 (仅在编辑模式下显示)**:
        -   展示可配置的广告位列表，每个广告位显示：广告位类型名称、当前关联的广告名称（如有），提供"选择广告"/"更改广告"/"取消关联"按钮。
        -   允许添加新的广告位类型（如需要）。
        -   "选择广告"功能会打开一个模态框，展示可供选择的广告列表（可以按广告类型筛选，确保为该广告位选择合适的广告）。
-   **`ApplicationDetailsPage.tsx`**: 展示单个应用的详细信息，包括其配置、以及所有广告位上分别关联的广告信息。

### 2.2 主要组件 (shadcn UI)

-   **`AppsTable.tsx`**: 使用 `Table` 展示应用列表，包含操作（编辑、查看详情、更改状态）。
-   **`AppForm.tsx`**: 表单，使用 `Input`, `Select` (用于终端类型), `FileUpload` (用于Logo) 等组件。
-   **`LogoUploader.tsx`**: 应用Logo上传组件，可能也使用Cloudflare R2存储。
-   **`AssociatedAdsList.tsx`**: 在应用详情页展示关联广告的列表组件。
-   **`AdAssignmentComponent.tsx`**: 新增组件，用于在应用编辑表单中，为广告位显示当前关联广告、并提供选择/更改/取消关联的交互。

### 2.3 状态管理 (Redux Toolkit)

-   **`applicationSlice.ts`**:
    -   `applications`: 应用列表。
    -   `currentApplication`: 当前查看或编辑的应用详情，包含其广告位列表，每个广告位包含 `placement_type` 和可能的关联广告对象摘要（名称等）。 **获取详情时，后端应动态查询并附加与此应用相关的广告点击数据。**
    -   `status`: API请求状态。
    -   `error`: 错误信息。
    -   **Thunks**:
        -   `fetchApplications(params)`
        -   `fetchApplicationById(appId)`
        -   `createApplication(appData)`
        -   `updateApplication(appId, appData)`
        -   `deleteApplication(appId)` (可能是软删除或有条件删除)
        -   `updateApplicationStatus(appId, status)`
        -   `assignAdToPlacement(appId, placementType, adId)`
        -   `removePlacement(appId, placementType)`

### 2.4 路由 (React Router 6)

```typescript
// src/App.tsx or routes configuration
<Routes>
  <Route path="/admin/applications" element={<AuthGuard><ApplicationListPage /></AuthGuard>} />
  <Route path="/admin/applications/new" element={<AuthGuard><ApplicationFormPage /></AuthGuard>} />
  <Route path="/admin/applications/:id/edit" element={<AuthGuard><ApplicationFormPage /></AuthGuard>} />
  <Route path="/admin/applications/:id" element={<AuthGuard><ApplicationDetailsPage /></AuthGuard>} />
</Routes>
```

### 2.5 API 服务 (`src/services/applicationApi.ts` - Axios)

```typescript
import axiosInstance from './axiosConfig';

export const getApplications = (params) => axiosInstance.get('/applications', { params });
export const getApplicationById = (id) => axiosInstance.get(`/applications/${id}`);
export const createApplication = (appData) => axiosInstance.post('/applications', appData); // appData might include logo file if not pre-uploaded
export const updateApplication = (id, appData) => axiosInstance.put(`/applications/${id}`, appData);
export const deleteApplication = (id) => axiosInstance.delete(`/applications/${id}`);
export const updateApplicationStatus = (id, statusData) => axiosInstance.patch(`/applications/${id}/status`, statusData);

// If logo is uploaded separately, similar to creatives:
// export const uploadAppLogo = (formData) => axiosInstance.post('/applications/logos/upload', formData, { headers: { 'Content-Type': 'multipart/form-data' } });
```

## 3. 后端设计 (Hono.js + Cloudflare Workers)

### 3.1 目录结构 (Conceptual)

```
src/
├── applications/             # 应用管理模块
│   ├── application.routes.ts # 应用相关路由
│   ├── application.controller.ts # 请求处理
│   ├── application.service.ts  # 核心业务逻辑
│   ├── application.validation.ts # 输入验证 (Zod)
│   └── application.model.ts  # 应用 Drizzle schema
├── middleware/
│   └── auth.middleware.ts
└── index.ts
```

### 3.2 主要逻辑

-   **应用 CRUD**: 创建、读取、更新、删除应用信息。
    -   创建应用时，自动生成唯一的应用码 (App Key / `app_key`)，用于SDK集成和API调用识别应用身份。
    -   Logo上传：可以将Logo文件直接随表单上传，或提供单独的Logo上传接口，成功后将Logo URL存入应用记录。推荐使用Cloudflare R2存储Logo。
-   **状态管理**: 实现应用状态的变更逻辑（例如，管理员审核通过后状态变为"已上线"）。
-   **与广告的关联**: 
    -   应用可以直接关联三个特定广告位（弹窗、横幅、Banner）的广告ID。
    -   在应用编辑保存时，更新 `applications` 表中对应的 `popup_advertisement_id`, `banner_advertisement_id`, `strip_advertisement_id`。
    -   取消关联意味着将对应的ID设置为NULL。

### 3.3 基础代码示例 (Conceptual)

**`src/applications/application.routes.ts` (Hono.js)**
```typescript
import { Hono } from 'hono';
import {
    createApplicationHandler,
    getApplicationsHandler,
    getApplicationByIdHandler,
    updateApplicationHandler,
    deleteApplicationHandler,
    updateApplicationStatusHandler
} from './application.controller';
import { protect, restrictTo } from '../middleware/auth.middleware'; // Assuming auth middleware

const appRouter = new Hono();
appRouter.use('*', protect); // Protect all application routes

appRouter.post('/', restrictTo(['super_admin']), createApplicationHandler); // Example: Only super_admin can create apps
appRouter.get('/', getApplicationsHandler);
appRouter.get('/:id', getApplicationByIdHandler);
appRouter.put('/:id', restrictTo(['super_admin']), updateApplicationHandler);
appRouter.delete('/:id', restrictTo(['super_admin']), deleteApplicationHandler);
appRouter.patch('/:id/status', restrictTo(['super_admin']), updateApplicationStatusHandler);

export default appRouter;
```

## 4. 数据库表设计 (PostgreSQL with Drizzle ORM)

### 4.1 `applications` 表
存储接入系统的应用信息。

| 字段名             | 类型                        | 约束/描述                                       | 对应图片字段 |
|--------------------|-----------------------------|-------------------------------------------------|--------------|
| `id`               | `UUID`                      | 主键, `DEFAULT uuid_generate_v4()`              |              |
| `name`             | `VARCHAR(255)`              | 非空, 应用名称                                  | 应用名称     |
| `app_key`          | `VARCHAR(255)`              | 非空, 唯一, 系统生成的应用唯一识别码            | 应用码       |
| `logo_url`         | `TEXT`                      | 可空, 应用Logo图片的URL (存储在Cloudflare R2)   | 应用Logo     |
| `platforms`        | `VARCHAR(50)[]`             | 非空, 数组类型, 至少包含一个元素。可选值: 'iOS', 'Android'. | 应用终端     |
| `website_url`      | `TEXT`                      | 可空, 应用官网地址                              | 官网地址     |
| `status`           | `VARCHAR(50)`               | 非空, `DEFAULT 'pending'` (e.g., pending, active, inactive, rejected) |              |
| `created_at`       | `TIMESTAMP WITH TIME ZONE`  | `DEFAULT CURRENT_TIMESTAMP`                     | 创建时间     |
| `updated_at`       | `TIMESTAMP WITH TIME ZONE`  | `DEFAULT CURRENT_TIMESTAMP`                     |              |

### 4.2 `app_ad_placements` 表
存储应用广告位与广告的关联关系。

| 字段名               | 类型                        | 约束/描述                                       |
|----------------------|-----------------------------|-------------------------------------------------|
| `id`                 | `UUID`                      | 主键, `DEFAULT uuid_generate_v4()`              |
| `application_id`     | `UUID`                      | 非空, 外键关联 `applications.id`, `ON DELETE CASCADE` |
| `advertisement_id`   | `UUID`                      | 非空, 外键关联 `advertisements.id`, `ON DELETE SET NULL` |
| `placement_type`     | `VARCHAR(50)`               | 非空, 广告位类型 (e.g., 'popup', 'banner', 'strip') |
| `created_at`         | `TIMESTAMP WITH TIME ZONE`  | `DEFAULT CURRENT_TIMESTAMP`                     |
| `updated_at`         | `TIMESTAMP WITH TIME ZONE`  | `DEFAULT CURRENT_TIMESTAMP`                     |

**联合唯一约束**: `(application_id, placement_type)` - 一个应用的特定广告位类型只能关联一个广告

**说明**: 

- 应用的总历史广告点击量将不在 `applications` 表中直接存储。它将通过查询 `ad_statistics` 表（在广告管理模块中定义）动态计算得出。
- 通过 `app_ad_placements` 表，可以灵活地为应用添加、移除不同类型的广告位，而无需修改数据库结构。系统可以预设三种类型（popup、banner、strip），但也可以灵活扩展其他类型。

**Drizzle Schema (`src/applications/application.model.ts`)**:
```typescript
import { pgTable, uuid, varchar, text, timestamp, specificType } from 'drizzle-orm/pg-core';
import { relations } from 'drizzle-orm';

export const applications = pgTable('applications', {
  id: uuid('id').defaultRandom().primaryKey(),
  name: varchar('name', { length: 255 }).notNull(),
  appKey: varchar('app_key', { length: 255 }).unique().notNull(),
  logoUrl: text('logo_url'),
  platforms: specificType('platforms', 'varchar(50)[]').notNull(),
  websiteUrl: text('website_url'),
  status: varchar('status', { length: 50 }).default('pending').notNull(),
  createdAt: timestamp('created_at', { withTimezone: true }).defaultNow().notNull(),
  updatedAt: timestamp('updated_at', { withTimezone: true }).defaultNow().notNull(),
});

export const appAdPlacements = pgTable('app_ad_placements', {
  id: uuid('id').defaultRandom().primaryKey(),
  applicationId: uuid('application_id')
    .notNull()
    .references(() => applications.id, { onDelete: 'cascade' }),
  advertisementId: uuid('advertisement_id')
    .notNull(), // .references(() => advertisements.id, { onDelete: 'set null' }),
  placementType: varchar('placement_type', { length: 50 }).notNull(), // 'popup', 'banner', 'strip', etc.
  createdAt: timestamp('created_at', { withTimezone: true }).defaultNow().notNull(),
  updatedAt: timestamp('updated_at', { withTimezone: true }).defaultNow().notNull(),
}, (table) => {
  return {
    applicationPlacementTypeUnique: uniqueIndex('application_placement_type_unique_idx')
      .on(table.applicationId, table.placementType),
  }
});

export const applicationsRelations = relations(applications, ({ many }) => ({
  adPlacements: many(appAdPlacements),
}));

export const appAdPlacementsRelations = relations(appAdPlacements, ({ one }) => ({
  application: one(applications, {
    fields: [appAdPlacements.applicationId],
    references: [applications.id],
  }),
  // advertisement: one(advertisements, {
  //   fields: [appAdPlacements.advertisementId],
  //   references: [advertisements.id],
  // }),
}));
```

## 5. API 接口设计 (RESTful)

所有接口均以 `/api/applications` 为前缀。

-   **`GET /`**
    -   描述: 获取应用列表 (支持分页、搜索、筛选)。
    -   查询参数: `?page=1&limit=10&search=keyword&platform=Android&status=active`
    -   成功响应 (200): `{ "data": [application_objects], "pagination": { ... } }`
-   **`POST /`**
    -   描述: 创建新应用。
    -   请求体: `{ "name": "string", "platforms": ["iOS", "Android"], "website_url": "string", "logo_file": File }` (Logo可随表单上传或通过独立接口上传后传URL)。`app_key`由后端生成。platforms数组至少包含一项。
    -   成功响应 (201): `{ ...created_application_object_with_app_key }`
-   **`GET /:id`**
    -   描述: 获取指定应用详情。
    -   成功响应 (200): `{ ...application_object, adPlacements: [{ id: "uuid", placementType: "popup", advertisement: {...} }], associatedAdPerformance: [{ advertisementId: 'uuid', advertisementName: 'Ad Name', clicksInThisApp: 1234, impressionsInThisApp: 50000, clickThroughRate: 0.02468 }, ...], historicalTotalClicksInApp: 5678 }` 
        (后端动态从 `ad_statistics` 表查询与此应用相关的广告表现数据，包括各广告的点击量、曝光量、计算点击率，以及该应用历史上的总广告点击量)。
-   **`PUT /:id`**
    -   描述: 更新指定应用的基本信息。
    -   请求体: (应用对象的部分或全部可更新字段)
    -   成功响应 (200): `{ ...updated_application_object }`
-   **`DELETE /:id`**
    -   描述: 删除指定应用 (需考虑关联广告的处理逻辑，可能是软删除或禁止删除有活动广告的应用)。
    -   成功响应 (204): No Content
-   **`PATCH /:id/status`**
    -   描述: 更新指定应用的状态。
    -   请求体: `{ "status": "active" }`
    -   成功响应 (200): `{ ...updated_application_object }`

### 5.1 广告位管理API

-   **`POST /:id/placements`**
    -   描述: 为应用添加新的广告位并关联广告。
    -   请求体: `{ "placementType": "popup", "advertisementId": "uuid" }`
    -   成功响应 (201): `{ ...created_placement_object }`
-   **`PUT /:id/placements/:placementType`**
    -   描述: 更新应用特定广告位关联的广告。
    -   请求体: `{ "advertisementId": "uuid" }`
    -   成功响应 (200): `{ ...updated_placement_object }`
-   **`DELETE /:id/placements/:placementType`**
    -   描述: 移除应用的特定广告位。
    -   成功响应 (204): No Content

---
此文档为应用管理模块提供了一个全面的设计框架，与广告管理模块紧密配合，共同构成了广告系统的核心。实际开发中，请根据具体的业务流程和用户体验需求进行调整。 